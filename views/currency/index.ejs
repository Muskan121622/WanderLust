<% layout("/layouts/boilerplate") %>

<div class="currency-converter-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="converter-header text-center mb-5">
                    <h1><i class="fa-solid fa-exchange-alt me-3"></i>Currency Converter</h1>
                    <p class="lead">Convert currencies instantly with real-time exchange rates</p>
                </div>

                <!-- Converter Card -->
                <div class="converter-card">
                    <div class="row">
                        <!-- From Currency -->
                        <div class="col-md-5 mb-4">
                            <label class="form-label">
                                <i class="fa-solid fa-arrow-right me-2"></i>From
                            </label>
                            <div class="currency-input-group">
                                <select class="form-select currency-select" id="fromCurrency">
                                    <% currencies.forEach(currency => { %>
                                        <option value="<%= currency.code %>" <%= currency.code === 'USD' ? 'selected' : '' %>>
                                            <%= currency.flag %> <%= currency.code %> - <%= currency.name %>
                                        </option>
                                    <% }); %>
                                </select>
                                <div class="input-group">
                                    <span class="input-group-text currency-symbol" id="fromSymbol">$</span>
                                    <input type="number" class="form-control amount-input" id="fromAmount"
                                           placeholder="Enter amount" value="1" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Swap Button -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center mb-4">
                            <button class="btn btn-outline-primary swap-btn" id="swapCurrencies" title="Swap currencies">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            </button>
                        </div>

                        <!-- To Currency -->
                        <div class="col-md-5 mb-4">
                            <label class="form-label">
                                <i class="fa-solid fa-arrow-left me-2"></i>To
                            </label>
                            <div class="currency-input-group">
                                <select class="form-select currency-select" id="toCurrency">
                                    <% currencies.forEach(currency => { %>
                                        <option value="<%= currency.code %>" <%= currency.code === 'EUR' ? 'selected' : '' %>>
                                            <%= currency.flag %> <%= currency.code %> - <%= currency.name %>
                                        </option>
                                    <% }); %>
                                </select>
                                <div class="input-group">
                                    <span class="input-group-text currency-symbol" id="toSymbol">€</span>
                                    <input type="number" class="form-control amount-input" id="toAmount"
                                           placeholder="Converted amount" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exchange Rate Display -->
                    <div class="exchange-rate-display mb-4">
                        <div class="rate-info">
                            <span class="rate-text" id="exchangeRate">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                1 USD = 0.85 EUR
                            </span>
                            <small class="text-muted ms-2" id="lastUpdated">Updated just now</small>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button class="btn btn-primary btn-lg me-3" id="convertBtn">
                            <i class="fa-solid fa-calculator me-2"></i>
                            Convert
                        </button>
                        <button class="btn btn-outline-secondary btn-lg" id="resetBtn">
                            <i class="fa-solid fa-refresh me-2"></i>
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Popular Conversions -->
                <div class="popular-conversions mt-5">
                    <h3 class="text-center mb-4">Popular Conversions</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="popular-card" data-from="USD" data-to="EUR">
                                <div class="conversion-pair">
                                    <span class="from-currency">🇺🇸 USD</span>
                                    <i class="fa-solid fa-arrow-right mx-2"></i>
                                    <span class="to-currency">🇪🇺 EUR</span>
                                </div>
                                <div class="conversion-rate" id="usd-eur-rate">Loading...</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="popular-card" data-from="USD" data-to="GBP">
                                <div class="conversion-pair">
                                    <span class="from-currency">🇺🇸 USD</span>
                                    <i class="fa-solid fa-arrow-right mx-2"></i>
                                    <span class="to-currency">🇬🇧 GBP</span>
                                </div>
                                <div class="conversion-rate" id="usd-gbp-rate">Loading...</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="popular-card" data-from="USD" data-to="INR">
                                <div class="conversion-pair">
                                    <span class="from-currency">🇺🇸 USD</span>
                                    <i class="fa-solid fa-arrow-right mx-2"></i>
                                    <span class="to-currency">🇮🇳 INR</span>
                                </div>
                                <div class="conversion-rate" id="usd-inr-rate">Loading...</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="popular-card" data-from="EUR" data-to="GBP">
                                <div class="conversion-pair">
                                    <span class="from-currency">🇪🇺 EUR</span>
                                    <i class="fa-solid fa-arrow-right mx-2"></i>
                                    <span class="to-currency">🇬🇧 GBP</span>
                                </div>
                                <div class="conversion-rate" id="eur-gbp-rate">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversion History -->
                <div class="conversion-history mt-5">
                    <h3 class="text-center mb-4">Recent Conversions</h3>
                    <div class="history-list" id="conversionHistory">
                        <div class="text-center text-muted">
                            <i class="fa-solid fa-history fa-2x mb-2"></i>
                            <p>Your recent conversions will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.currency-converter-container {
    min-height: 100vh;
    padding: 2rem 0;
    background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(254, 66, 77, 0.05) 100%);
}

.converter-header h1 {
    color: var(--text-primary);
    font-weight: 700;
    margin-bottom: 1rem;
}

.converter-card {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.currency-input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.currency-select {
    border-radius: 12px;
    border: 2px solid var(--border-color);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
}

.currency-select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.25rem rgba(254, 66, 77, 0.15);
}

.amount-input {
    border-radius: 0 12px 12px 0;
    border: 2px solid var(--border-color);
    border-left: none;
    padding: 0.75rem 1rem;
    font-size: 1.1rem;
    font-weight: 500;
}

.amount-input:focus {
    border-color: var(--accent-color);
    box-shadow: none;
}

.currency-symbol {
    border-radius: 12px 0 0 12px;
    border: 2px solid var(--border-color);
    border-right: none;
    background: var(--bg-secondary);
    font-weight: 600;
    font-size: 1.1rem;
}

.swap-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.swap-btn:hover {
    transform: rotate(180deg);
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.exchange-rate-display {
    background: rgba(108, 117, 125, 0.05);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}

.rate-info {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.rate-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.popular-conversions {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.popular-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
}

.popular-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: var(--accent-color);
}

.conversion-pair {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.conversion-rate {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--accent-color);
}

.conversion-history {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.history-list {
    max-height: 300px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.history-item:last-child {
    border-bottom: none;
}

.history-conversion {
    font-weight: 500;
    color: var(--text-primary);
}

.history-rate {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .converter-card, .popular-conversions, .conversion-history {
        padding: 1.5rem;
    }

    .swap-btn {
        margin-top: 1rem;
    }

    .popular-card {
        margin-bottom: 0.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fromCurrency = document.getElementById('fromCurrency');
    const toCurrency = document.getElementById('toCurrency');
    const fromAmount = document.getElementById('fromAmount');
    const toAmount = document.getElementById('toAmount');
    const fromSymbol = document.getElementById('fromSymbol');
    const toSymbol = document.getElementById('toSymbol');
    const exchangeRate = document.getElementById('exchangeRate');
    const lastUpdated = document.getElementById('lastUpdated');
    const convertBtn = document.getElementById('convertBtn');
    const resetBtn = document.getElementById('resetBtn');
    const swapBtn = document.getElementById('swapCurrencies');
    const conversionHistory = document.getElementById('conversionHistory');

    // Currency symbols mapping
    const currencySymbols = {
        'USD': '$', 'EUR': '€', 'GBP': '£', 'INR': '₹', 'JPY': '¥',
        'CAD': 'C$', 'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¥', 'KRW': '₩',
        'BRL': 'R$', 'MXN': '$', 'SGD': 'S$', 'HKD': 'HK$', 'NZD': 'NZ$',
        'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr', 'PLN': 'zł', 'CZK': 'Kč'
    };

    // Conversion history
    let history = JSON.parse(localStorage.getItem('currencyHistory') || '[]');

    // Update currency symbols
    function updateSymbols() {
        fromSymbol.textContent = currencySymbols[fromCurrency.value] || fromCurrency.value;
        toSymbol.textContent = currencySymbols[toCurrency.value] || toCurrency.value;
    }

    // Convert currency
    async function convertCurrency() {
        const from = fromCurrency.value;
        const to = toCurrency.value;
        const amount = parseFloat(fromAmount.value);

        if (!amount || amount <= 0) {
            alert('Please enter a valid amount');
            return;
        }

        try {
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Converting...';

            const response = await fetch(`/currency/api/convert?from=${from}&to=${to}&amount=${amount}`);
            const data = await response.json();

            if (data.success) {
                toAmount.value = data.conversion.result.toFixed(2);
                exchangeRate.innerHTML = `<i class="fa-solid fa-info-circle me-2"></i>1 ${from} = ${data.conversion.rate.toFixed(4)} ${to}`;
                lastUpdated.textContent = 'Updated just now';

                // Add to history
                addToHistory(data.conversion);
            } else {
                alert('Conversion failed: ' + data.error);
            }
        } catch (error) {
            console.error('Conversion error:', error);
            alert('Failed to convert currency. Please try again.');
        } finally {
            convertBtn.disabled = false;
            convertBtn.innerHTML = '<i class="fa-solid fa-calculator me-2"></i>Convert';
        }
    }

    // Add conversion to history
    function addToHistory(conversion) {
        const historyItem = {
            from: conversion.from,
            to: conversion.to,
            amount: conversion.amount,
            result: conversion.result,
            rate: conversion.rate,
            timestamp: new Date().toISOString()
        };

        history.unshift(historyItem);
        if (history.length > 10) {
            history = history.slice(0, 10);
        }

        localStorage.setItem('currencyHistory', JSON.stringify(history));
        updateHistoryDisplay();
    }

    // Update history display
    function updateHistoryDisplay() {
        if (history.length === 0) {
            conversionHistory.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fa-solid fa-history fa-2x mb-2"></i>
                    <p>Your recent conversions will appear here</p>
                </div>
            `;
            return;
        }

        conversionHistory.innerHTML = history.map(item => `
            <div class="history-item">
                <div>
                    <div class="history-conversion">
                        ${item.amount} ${item.from} = ${item.result.toFixed(2)} ${item.to}
                    </div>
                    <div class="history-rate">
                        1 ${item.from} = ${item.rate.toFixed(4)} ${item.to}
                    </div>
                </div>
                <small class="text-muted">${new Date(item.timestamp).toLocaleDateString()}</small>
            </div>
        `).join('');
    }

    // Load popular rates
    async function loadPopularRates() {
        const pairs = [
            { from: 'USD', to: 'EUR', element: 'usd-eur-rate' },
            { from: 'USD', to: 'GBP', element: 'usd-gbp-rate' },
            { from: 'USD', to: 'INR', element: 'usd-inr-rate' },
            { from: 'EUR', to: 'GBP', element: 'eur-gbp-rate' }
        ];

        for (const pair of pairs) {
            try {
                const response = await fetch(`/currency/api/convert?from=${pair.from}&to=${pair.to}&amount=1`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById(pair.element).textContent =
                        `${currencySymbols[pair.from] || pair.from}1 = ${currencySymbols[pair.to] || pair.to}${data.conversion.result.toFixed(2)}`;
                }
            } catch (error) {
                document.getElementById(pair.element).textContent = 'Rate unavailable';
            }
        }
    }

    // Event listeners
    fromCurrency.addEventListener('change', updateSymbols);
    toCurrency.addEventListener('change', updateSymbols);

    fromAmount.addEventListener('input', function() {
        if (this.value && parseFloat(this.value) > 0) {
            convertCurrency();
        }
    });

    convertBtn.addEventListener('click', convertCurrency);

    resetBtn.addEventListener('click', function() {
        fromAmount.value = '1';
        toAmount.value = '';
        exchangeRate.innerHTML = '<i class="fa-solid fa-info-circle me-2"></i>Select currencies and enter amount';
        lastUpdated.textContent = '';
    });

    swapBtn.addEventListener('click', function() {
        const tempCurrency = fromCurrency.value;
        const tempAmount = fromAmount.value;

        fromCurrency.value = toCurrency.value;
        toCurrency.value = tempCurrency;

        fromAmount.value = toAmount.value || '1';
        toAmount.value = tempAmount;

        updateSymbols();
        convertCurrency();
    });

    // Popular conversion cards click
    document.querySelectorAll('.popular-card').forEach(card => {
        card.addEventListener('click', function() {
            const from = this.dataset.from;
            const to = this.dataset.to;

            fromCurrency.value = from;
            toCurrency.value = to;
            fromAmount.value = '1';

            updateSymbols();
            convertCurrency();

            // Scroll to converter
            document.querySelector('.converter-card').scrollIntoView({ behavior: 'smooth' });
        });
    });

    // Initialize
    updateSymbols();
    updateHistoryDisplay();
    loadPopularRates();

    // Auto-convert on page load
    setTimeout(() => {
        convertCurrency();
    }, 500);
});
</script>
