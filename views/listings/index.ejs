<% layout('/layouts/boilerplate') %>

    <style>
        /* New gradient filter bar */
        #filters {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 1rem;
            gap: 1rem;
            margin-top: 10px;
            border-radius: 20px;
            background:var(--bg-primary);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }


        .filter {
            text-align: center;
            color: white;
            white-space: nowrap;
        }

        /* tax toggle restyled */
        .tax-toggle {
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: auto;
            color: white;
        }

        /* Hide scrollbar */
        #filters::-webkit-scrollbar {
            display: none;
        }

        /* Card refinements */
        .listing-card {
            border: none !important;
            border-radius: 1.2rem !important;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .listing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.15);
        }

        .listing-image-container {
            height: 18rem;
        }

        .listing-card .card-body {
            padding: 1rem;
        }

        .listing-badges {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
        }

        .badge-new {
            background-color: #28a745;
            color: white;
        }

        .badge-featured {
            background-color: #007bff;
            color: white;
        }

        .badge-discount {
            background-color: #dc3545;
            color: white;
        }

        .badge-rated {
            background-color: #ffc107;
            color: white;
        }

        .badge-featured-review {
            background-color: #17a2b8;
            color: white;
        }
        
    </style>


    <div id="filters">
        <div class="tax-toggle">
            <div class="form-check-reverse form-switch">
                <input class="form-check-input tax-input" type="checkbox" role="switch" id="switchCheckDefault" />
                <label class="form-check-label" for="switchCheckDefault"><b>Display total after taxes</b></label>
            </div>
        </div>
        <a href="/listings?category=Trending" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Trending') ? 'active' : '' %>">
            <i class="fa-solid fa-fire"></i>
            <p>Trending</p>
        </div>
        </a>

        <a href="/listings?category=Rooms" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Rooms') ? 'active' : '' %>">
            <i class="fa-solid fa-bed"></i>
            <p>Rooms</p>
        </div>
        </a>


        <a href="/listings?category=Iconic Cities" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Iconic Cities') ? 'active' : '' %>">
            <i class="fa-solid fa-mountain-city"></i>
            <p>Iconic Cities</p>
        </div>
        </a>


        <a href="/listings?category=Mountains" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Mountains') ? 'active' : '' %>">
            <i class="fa-solid fa-mountain"></i>
            <p>Mountains</p>
        </div>
        </a>


        <a href="/listings?category=Castles" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Castles') ? 'active' : '' %>">
            <i class="fa-solid fa-chess-rook"></i>
            <p>Castles</p>
        </div>
        </a>
        

        <a href="/listings?category=Amazing pool" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Amazing pool') ? 'active' : '' %>">
            <i class="fa-solid fa-person-swimming"></i>
            <p>Amazing pool</p>
        </div>
        </a>
        

        <a href="/listings?category=Camping" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Camping') ? 'active' : '' %>">
            <i class="fa-solid fa-tents"></i>
            <p>Camping</p>
        </div>
        </a>
        

        <a href="/listings?category=Farms" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Farms') ? 'active' : '' %>">
            <i class="fa-solid fa-tractor"></i>
            <p>Farms</p>
        </div>
        </a>
        

        <a href="/listings?category=Arctic" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Arctic') ? 'active' : '' %>">
            <i class="fa-solid fa-snowflake"></i>
            <p>Arctic</p>
        </div>
        </a>
        

        <a href="/listings?category=Domes" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Domes') ? 'active' : '' %>">
            <i class="fa-solid fa-igloo"></i>
            <p>Domes</p>
        </div>
        </a>
        

        <a href="/listings?category=Boats" style="text-decoration: none; color: inherit;">
        <div class="filter  <%= (category === 'Boats') ? 'active' : '' %>">
            <i class="fa-solid fa-ship"></i>
            <p>Boats</p>
        </div>
        </a>
        
    </div>


    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 mt-3">
        <% for(let listing of allListings) { %>
            <div class="col mb-4">
                <a href="/listings/<%= listing._id %>" class="listing-link">
                    <div class="card listing-card h-100">
                        <div class="listing-badges">
        <% if (listing.isNewBadge) { %>
            <span class="badge badge-new">New</span>
        <% } %>
        <% if (listing.isFeaturedBadge) { %>
            <span class="badge badge-featured">Featured</span>
        <% } %>
        <% if (listing.isDiscountBadge) { %>
            <span class="badge badge-discount">Discount</span>
        <% } %>
        <% if (listing.isHighlyRatedBadge) { %>
            <span class="badge badge-rated highly-rated-badge" 
                data-title="<%= listing.title.replace(/"/g, '&quot;') %>" 
                data-avg="<%= listing.avgRating ? listing.avgRating.toFixed(2) : '0.00' %>">Highly Rated</span>
        <% } %>
        <% if (listing.hasFeaturedReview) { %>
            <span class="badge badge-featured-review">Featured Review</span>
        <% } %>
    </div>
                        <div class="listing-image-container">
                            <img src="<%= listing.image && listing.image.url ? listing.image.url : 'https://via.placeholder.com/300' %>" class="card-img-top listing-image"
                                alt="listing_image" />
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <b>
                                    <%= listing.title %>
                                </b><br />
                                <%= typeof listing.price !== 'undefined' ? listing.price.toLocaleString("en-IN") : 'N/A' %> / night
                                    <i class="tax-info">&nbsp; &nbsp; +18% GST</i>
                            </p>
                        </div>
                    </div>
                </a>
            </div>
            <% } %>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let taxSwitch = document.getElementById("switchCheckDefault");
            if (taxSwitch) {
                taxSwitch.addEventListener("click", () => {
                    let taxInfo = document.getElementsByClassName("tax-info");
                    for (let info of taxInfo) {
                        info.style.display = (info.style.display !== "inline") ? "inline" : "none";
                    }
                });
            }
            function showRatedModal(title, avgRating) {
                const modal = document.createElement('div');
                modal.id = 'rated-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.25)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '9999';

                modal.innerHTML = `
                    <div style="background: rgba(255,255,255,0.95); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); padding: 2rem 2.5rem; text-align: center; max-width: 350px;">
                        <h3 style="color: #1976d2; font-weight: bold; margin-bottom: 1rem;">Highly Rated</h3>
                        <div style="margin-bottom: 1rem; color: #333;">This listing is popular with guests! It has an average rating of <b>${avgRating}/5</b> stars, based on real guest reviews.</div>
                        <div style="font-size: 1.5rem; color: #ffc107; margin-bottom: 1.5rem;">
                            ${'★'.repeat(Math.round(avgRating))}${'☆'.repeat(5 - Math.round(avgRating))}
                        </div>
                        <button id="close-rated-modal" style="background: #1976d2; color: white; border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-size: 1rem; cursor: pointer;">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('close-rated-modal').onclick = function() {
                    document.body.removeChild(modal);
                };
            }
            // Attach event listeners for badges
            document.querySelectorAll('.highly-rated-badge').forEach(function(badge) {
                badge.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showRatedModal(badge.getAttribute('data-title'), badge.getAttribute('data-avg'));
                });
            });
            // Attach event listener for test button
            var testBtn = document.getElementById('test-modal-btn');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    showRatedModal('Test Listing', 4.75);
                });
            }
        });
    </script>