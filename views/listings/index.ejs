<% layout('/layouts/boilerplate') %>

    <style>
        /* Core Controls */
        .controls-bar {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .controls-bar .btn {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Filters Bar */
        #filters {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 1rem;
            margin-top: 10px;
            border-radius: 20px;
            background: var(--bg-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        #filters::-webkit-scrollbar {
            display: none;
        }

        .filters-container {
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: space-evenly;
            gap: 0.5rem;
            min-width: 0;
        }

        .filter {
            text-align: center;
            color: white;
            white-space: nowrap;
            flex-shrink: 0;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filter:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .filter.active {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Tax Toggle */
        .tax-toggle {
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
        }

        /* Default: Black text for light mode - Maximum Specificity */
        .tax-toggle .form-check-label,
        .tax-toggle .form-check-label.tax-label-text,
        .tax-toggle .form-check-label b,
        .tax-toggle .form-check-label b.tax-text,
        .tax-toggle .form-check-label *,
        .tax-toggle .tax-label-text,
        .tax-toggle .tax-text {
            color: #000000 !important;
            fill: #000000 !important;
        }

        /* White text ONLY in dark mode - Multiple selectors for compatibility */
        [data-theme="dark"] .tax-toggle .form-check-label,
        [data-theme="dark"] .tax-toggle .form-check-label.tax-label-text,
        [data-theme="dark"] .tax-toggle .form-check-label b,
        [data-theme="dark"] .tax-toggle .form-check-label b.tax-text,
        [data-theme="dark"] .tax-toggle .form-check-label *,
        [data-theme="dark"] .tax-toggle .tax-label-text,
        [data-theme="dark"] .tax-toggle .tax-text,
        html[data-theme="dark"] .tax-toggle .form-check-label,
        html[data-theme="dark"] .tax-toggle .form-check-label b,
        html[data-theme="dark"] .tax-toggle .tax-label-text,
        html[data-theme="dark"] .tax-toggle .tax-text,
        body[data-theme="dark"] .tax-toggle .form-check-label,
        body[data-theme="dark"] .tax-toggle .form-check-label b,
        body[data-theme="dark"] .tax-toggle .tax-label-text,
        body[data-theme="dark"] .tax-toggle .tax-text {
            color: #ffffff !important;
            fill: #ffffff !important;
        }

        /* Tax Info */
        .tax-info {
            color: var(--text-muted, #6c757d);
            font-size: 0.85rem;
            font-weight: 400;
        }

        /* Advanced Filters */
        .advanced-filters-container {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .filters-panel .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .filters-panel .form-control,
        .filters-panel .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Active Filters Tags */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-tag {
            background: var(--accent-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-tag .remove-filter {
            cursor: pointer;
            font-weight: bold;
        }

        /* Listing Cards */
        .listing-card {
            border: none;
            border-radius: 1.2rem;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .listing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.15);
        }

        .listing-image-container {
            height: 18rem;
            position: relative;
        }

        .listing-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Badges */
        .listing-badges {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-new {
            background-color: #28a745;
            color: white;
        }

        .badge-featured {
            background-color: #007bff;
            color: white;
        }

        .badge-discount {
            background-color: #dc3545;
            color: white;
        }

        .badge-rated {
            background-color: #ffc107;
            color: white;
        }

        /* Compare Checkbox */
        .compare-checkbox {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #2d3748;
            transition: all 0.2s ease;
        }

        .compare-checkbox:hover {
            border-color: #fe424d;
            color: #fe424d;
            box-shadow: 0 0 0 3px rgba(254, 66, 77, 0.1);
        }

        .compare-checkbox input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        /* Compare Button */
        #compare-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #fe424d;
            color: white;
            padding: 0.8rem 1.5rem;
            border: 2px solid #fe424d;
            border-radius: 25px;
            box-shadow: 0 6px 20px rgba(254, 66, 77, 0.4);
            font-weight: 700;
            cursor: pointer;
            display: none;
            z-index: 9999;
            transition: all 0.2s ease;
        }

        #compare-btn:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 66, 77, 0.5);
        }

        /* Search Results */
        .search-results-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .no-results-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border-radius: 20px;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Loading */
        .loading-indicator {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 2rem;
        }

        .listings-container.loading {
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .advanced-filters-container {
                padding: 1rem;
            }

            #compare-btn {
                bottom: 1rem;
                right: 1rem;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>

    <!-- Category Filters -->
    <div id="filters">
        <div class="filters-container">
            <% const categories=[ {name: 'Trending' , icon: 'fa-fire' }, {name: 'Rooms' , icon: 'fa-bed' },
                {name: 'Iconic Cities' , icon: 'fa-mountain-city' }, {name: 'Mountains' , icon: 'fa-mountain' },
                {name: 'Castles' , icon: 'fa-chess-rook' }, {name: 'Amazing pool' , icon: 'fa-person-swimming' },
                {name: 'Camping' , icon: 'fa-tents' }, {name: 'Farms' , icon: 'fa-tractor' }, {name: 'Arctic' ,
                icon: 'fa-snowflake' }, {name: 'Domes' , icon: 'fa-igloo' }, {name: 'Boats' , icon: 'fa-ship' } ]; %>

                <% categories.forEach(cat=> { %>
                    <a href="/listings?category=<%= cat.name %>" style="text-decoration: none; color: inherit;">
                        <div class="filter <%= (category === cat.name) ? 'active' : '' %>">
                            <i class="fa-solid <%= cat.icon %>"></i>
                            <p>
                                <%= cat.name %>
                            </p>
                        </div>
                    </a>
                    <% }); %>
        </div>
    </div>

    <!-- Controls Bar -->
    <div class="controls-bar mt-3">
        <div class="row g-3">
            <div class="col-md-6">
                <button class="btn btn-outline-primary w-100" id="showAdvancedFilters">
                    <i class="fa-solid fa-sliders-h me-2"></i>Advanced Filters
                </button>
            </div>
            <div class="col-md-6">
                <div class="tax-toggle w-100">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="taxToggle">
                        <label class="form-check-label tax-label-text" for="taxToggle">
                            <b class="tax-text">Display total after taxes</b>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters mb-3" id="activeFilters" style="display: none;"></div>

    <!-- Advanced Filters Panel -->
    <div class="advanced-filters-container mb-4" style="display: none;">
        <div class="filters-panel">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy">
                        <option value="newest">Newest First</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="rating">Highest Rated</option>
                        <option value="popularity">Most Popular</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Country</label>
                    <select class="form-select" id="countryFilter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Price</label>
                    <input type="number" class="form-control" id="minPrice" placeholder="₹">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max Price</label>
                    <input type="number" class="form-control" id="maxPrice" placeholder="₹">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Rating</label>
                    <select class="form-select" id="minRating">
                        <option value="">Any Rating</option>
                        <option value="4.5">4.5+ Stars</option>
                        <option value="4.0">4.0+ Stars</option>
                        <option value="3.5">3.5+ Stars</option>
                        <option value="3.0">3.0+ Stars</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fa-solid fa-filter me-2"></i>Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary ms-2" id="clearFilters">
                        <i class="fa-solid fa-times me-2"></i>Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator text-center my-4" id="loadingIndicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Filtering listings...</p>
    </div>

    <!-- Search Results Header -->
    <% if (searchQuery) { %>
        <div class="search-results-header mt-4 mb-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">
                        <i class="fas fa-search text-primary me-2"></i>
                        Search Results for "<%= searchQuery %>"
                    </h4>
                    <p class="text-muted mb-0">
                        <% if (totalResults> 0) { %>
                            Found <%= totalResults %>
                                <%= totalResults===1 ? 'listing' : 'listings' %>
                                    <% } else { %>
                                        No listings found
                                        <% } %>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/listings" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Clear Search
                    </a>
                </div>
            </div>
        </div>
        <% } %>

            <!-- No Results Message -->
            <% if (searchQuery && totalResults===0) { %>
                <div class="no-results-container text-center py-5">
                    <i class="fas fa-search fa-4x text-muted mb-4"></i>
                    <h3 class="text-muted mb-3">No listings found</h3>
                    <p class="text-muted mb-4">
                        We couldn't find any listings matching "<strong>
                            <%= searchQuery %>
                        </strong>".
                    </p>
                    <div class="search-suggestions">
                        <h5 class="mb-3">Try searching for:</h5>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <a href="/listings?search=beach" class="btn btn-outline-primary btn-sm">Beach</a>
                            <a href="/listings?search=cabin" class="btn btn-outline-primary btn-sm">Cabin</a>
                            <a href="/listings?search=tokyo" class="btn btn-outline-primary btn-sm">Tokyo</a>
                            <a href="/listings?search=mountains" class="btn btn-outline-primary btn-sm">Mountains</a>
                        </div>
                    </div>
                </div>
                <% } %>

                    <!-- Listings Grid -->
                    <% if (allListings && allListings.length> 0) { %>
                        <div class="listings-container" id="listingsContainer">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 mt-3" id="listingsGrid">
                                <% allListings.forEach(listing=> { %>
                                    <div class="col mb-4">
                                        <a href="/listings/<%= listing._id %>" class="listing-link"
                                            style="text-decoration: none; color: inherit;">
                                            <div class="card listing-card h-100">
                                                <!-- Badges -->
                                                <div class="listing-badges">
                                                    <% if (listing.isNewBadge) { %>
                                                        <span class="badge badge-new">New</span>
                                                        <% } %>
                                                            <% if (listing.isFeaturedBadge) { %>
                                                                <span class="badge badge-featured">Featured</span>
                                                                <% } %>
                                                                    <% if (listing.isDiscountBadge) { %>
                                                                        <span
                                                                            class="badge badge-discount">Discount</span>
                                                                        <% } %>
                                                                            <% if (listing.isHighlyRatedBadge) { %>
                                                                                <span class="badge badge-rated">Highly
                                                                                    Rated</span>
                                                                                <% } %>
                                                </div>

                                                <!-- Image -->
                                                <div class="listing-image-container">
                                                    <img src="<%= listing.image?.url || 'https://via.placeholder.com/300' %>"
                                                        class="listing-image" alt="<%= listing.title %>">
                                                </div>

                                                <!-- Card Body -->
                                                <div class="card-body">
                                                    <b class="listing-title">
                                                        <%= listing.title %>
                                                    </b><br>
                                                    <small class="text-muted listing-location">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        <%= listing.location %>, <%= listing.country %>
                                                    </small><br>
                                                    <span class="listing-price" data-base-price="<%= listing.price %>">
                                                        ₹<%= listing.price?.toLocaleString('en-IN') || 'N/A' %> / night
                                                            <i class="tax-info">&nbsp;+18% GST</i>
                                                    </span>
                                                </div>

                                                <!-- Compare Checkbox -->
                                                <div class="compare-checkbox"
                                                    onclick="event.preventDefault(); event.stopPropagation();">
                                                    <input type="checkbox" class="compare-item"
                                                        data-id="<%= listing._id %>" onclick="event.stopPropagation();">
                                                    <span>Compare</span>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>
                        <% } else if (!searchQuery) { %>
                            <div class="row mt-4">
                                <div class="col-12 text-center py-5 no-results-container">
                                    <i class="fas fa-home fa-4x text-muted mb-4"></i>
                                    <h3 class="text-muted mb-3">Welcome to WanderLust!</h3>
                                    <p class="text-muted mb-4">Be the first to add a listing!</p>
                                    <a href="/listings/new" class="btn btn-dark">
                                        <i class="fas fa-plus-circle me-2"></i>Create New Listing
                                    </a>
                                </div>
                            </div>
                            <% } %>

                                <!-- Floating Compare Button -->
                                <button id="compare-btn">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    Compare (<span id="compare-count">0</span>)
                                </button>

                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        // Tax Toggle
                                        const taxToggle = document.getElementById('taxToggle');
                                        if (taxToggle) {
                                            taxToggle.addEventListener('change', function () {
                                                updatePriceDisplay(this.checked);
                                                document.querySelectorAll('.tax-info').forEach(el => {
                                                    el.style.display = this.checked ? 'none' : 'inline';
                                                });
                                            });
                                        }

                                        function updatePriceDisplay(showWithTax) {
                                            document.querySelectorAll('.listing-price').forEach(el => {
                                                const basePrice = parseInt(el.dataset.basePrice);
                                                if (!basePrice) return;

                                                const displayPrice = showWithTax ? Math.round(basePrice * 1.18) : basePrice;
                                                const taxInfo = showWithTax ? '' : '<i class="tax-info">&nbsp;+18% GST</i>';
                                                el.innerHTML = `₹${displayPrice.toLocaleString('en-IN')} / night${taxInfo}`;
                                            });
                                        }

                                        // Advanced Filters Toggle
                                        document.getElementById('showAdvancedFilters')?.addEventListener('click', function () {
                                            const container = document.querySelector('.advanced-filters-container');
                                            const isHidden = container.style.display === 'none' || !container.style.display;
                                            container.style.display = isHidden ? 'block' : 'none';
                                            this.innerHTML = isHidden ?
                                                '<i class="fa-solid fa-times me-2"></i>Hide Filters' :
                                                '<i class="fa-solid fa-sliders-h me-2"></i>Advanced Filters';
                                        });

                                        // Load Countries
                                        fetch('/listings/api/filter?getCountries=true')
                                            .then(res => res.json())
                                            .then(data => {
                                                if (data.success && data.countries) {
                                                    const select = document.getElementById('countryFilter');
                                                    data.countries.forEach(country => {
                                                        const option = document.createElement('option');
                                                        option.value = country;
                                                        option.textContent = country;
                                                        select.appendChild(option);
                                                    });
                                                }
                                            })
                                            .catch(err => console.error('Error loading countries:', err));

                                        // Apply Filters
                                        document.getElementById('applyFilters')?.addEventListener('click', applyFilters);
                                        document.getElementById('clearFilters')?.addEventListener('click', clearFilters);

                                        function applyFilters() {
                                            const filters = {
                                                sortBy: document.getElementById('sortBy').value,
                                                country: document.getElementById('countryFilter').value,
                                                minPrice: document.getElementById('minPrice').value,
                                                maxPrice: document.getElementById('maxPrice').value,
                                                minRating: document.getElementById('minRating').value
                                            };

                                            // Remove empty values
                                            Object.keys(filters).forEach(key => !filters[key] && delete filters[key]);

                                            const queryString = new URLSearchParams(filters).toString();
                                            window.location.href = `/listings?${queryString}`;
                                        }

                                        function clearFilters() {
                                            ['sortBy', 'countryFilter', 'minPrice', 'maxPrice', 'minRating'].forEach(id => {
                                                const el = document.getElementById(id);
                                                if (el.tagName === 'SELECT') el.value = el.options[0].value;
                                                else el.value = '';
                                            });
                                            window.location.href = '/listings';
                                        }

                                        // Comparison Functionality
                                        let selectedListings = [];

                                        function updateCompareButton() {
                                            const btn = document.getElementById('compare-btn');
                                            const count = document.getElementById('compare-count');
                                            btn.style.display = selectedListings.length > 0 ? 'block' : 'none';
                                            count.textContent = selectedListings.length;
                                        }

                                        document.querySelectorAll('.compare-item').forEach(checkbox => {
                                            checkbox.addEventListener('change', function (e) {
                                                e.stopPropagation();
                                                const id = this.dataset.id;

                                                if (this.checked) {
                                                    if (selectedListings.length < 3) {
                                                        selectedListings.push(id);
                                                    } else {
                                                        this.checked = false;
                                                        alert('You can compare up to 3 destinations at once.');
                                                    }
                                                } else {
                                                    selectedListings = selectedListings.filter(listingId => listingId !== id);
                                                }

                                                updateCompareButton();
                                            });
                                        });

                                        document.getElementById('compare-btn')?.addEventListener('click', function () {
                                            if (selectedListings.length < 2) {
                                                alert('Please select at least 2 destinations to compare.');
                                                return;
                                            }
                                            window.location.href = `/listings/compare?ids=${selectedListings.join(',')}`;
                                        });
                                    });
                                </script>