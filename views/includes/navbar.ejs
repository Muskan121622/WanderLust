<nav class="navbar navbar-expand-md bg-body-light border-bottom sticky-top" role="navigation"
  aria-label="Main navigation">
  <div class="container-fluid">
    <!-- Brand -->
    <a class="navbar-brand mt-1 d-flex align-items-center" href="/listings" aria-label="WanderLust - Go to home page">
      <i class="fa-regular fa-compass me-2" aria-hidden="true"></i>
      <span class="fw-bold">
        <%= __('wanderlust') %>
      </span>
    </a>

    <!-- Mobile Toggle -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
      aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation menu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible Content -->
    <div class="collapse navbar-collapse" id="navbarContent">
      <!-- Primary Navigation -->
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" href="/listings">
            <i class="fa-regular fa-copy" aria-hidden="true"></i>
            <%= __('all_listings') %>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/listings/about">
            <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
            <%= __('about') %>
          </a>
        </li>

        <!-- Travel Tools Dropdown -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"
            id="travelToolsDropdown">
            <i class="fa-solid fa-tools" aria-hidden="true"></i>
            Travel Tools
          </a>
          <ul class="dropdown-menu" aria-labelledby="travelToolsDropdown">
            <li>
              <a class="dropdown-item" href="/trip-planner">
                <i class="fa-solid fa-route me-2" aria-hidden="true"></i>Trip Planner
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/packing-list">
                <i class="fa-solid fa-suitcase me-2" aria-hidden="true"></i>Packing List Generator
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/holiday">
                <i class="fa-solid fa-calendar-days me-2" aria-hidden="true"></i>Holiday Calendar
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/listings/compare">
                <i class="fa-solid fa-balance-scale me-2" aria-hidden="true"></i>Compare Destinations
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/trip-planner/mood-fixing">
                <i class="fa-solid fa-music me-2" aria-hidden="true"></i>Mood Fixing
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item" href="/weather">
                <i class="fa-solid fa-cloud-sun me-2" aria-hidden="true"></i>Weather Info
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item" href="/achievements">
                <i class="fa-solid fa-trophy me-2" aria-hidden="true"></i>Achievements
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/leaderboard">
                <i class="fa-solid fa-chart-line me-2" aria-hidden="true"></i>Leaderboard
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <!-- Search Bar -->
      <div class="search-container me-3">
        <form role="search" method="GET" action="/listings" aria-label="Search destinations">
          <div class="position-relative">
            <label for="searchInput" class="visually-hidden">Search destinations</label>
            <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
            <input class="search-input" type="search" name="search" id="searchInput"
              placeholder="<%= __('search_destinations') %>"
              value="<%= typeof searchQuery !== 'undefined' && searchQuery ? searchQuery : '' %>" autocomplete="off"
              aria-describedby="searchHelp" />
            <span id="searchHelp" class="visually-hidden">Search for travel destinations, accommodations, and
              experiences</span>
            <button class="search-btn" type="submit" aria-label="Submit search">
              <%= __('search') %>
            </button>
          </div>
          <div class="search-suggestions" id="searchSuggestions" role="listbox" aria-label="Search suggestions"></div>
        </form>
      </div>

      <!-- Authentication & Profile -->
      <div class="action-buttons d-flex align-items-center gap-2">
        <a class="nav-link" href="/listings/new">
          <%= __('add_new_listing') %>
        </a>

        <% if (typeof currentUser==='undefined' || !currentUser) { %>
          <a class="btn btn-outline-primary" href="/login">
            <i class="fa-solid fa-sign-in-alt me-1" aria-hidden="true"></i>
            <%= __('login') %>
          </a>
          <a class="btn btn-primary" href="/signup">
            <i class="fa-solid fa-user-plus me-1" aria-hidden="true"></i>
            <%= __('signup') %>
          </a>
          <% } else { %>
            <!-- Profile Dropdown -->
            <div class="dropdown">
              <button class="btn dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown"
                aria-expanded="false" aria-label="User profile menu">
                <i class="fa-solid fa-user me-1" aria-hidden="true"></i>
                <%= __('profile') %>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li>
                  <a class="dropdown-item" href="/profile">
                    <i class="fa-solid fa-user me-2" aria-hidden="true"></i>My Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/profile/wishlist">
                    <i class="fa-solid fa-bookmark me-2" aria-hidden="true"></i>My Wishlist
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/profile/likes">
                    <i class="fa-solid fa-heart me-2" aria-hidden="true"></i>Liked Listings
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/profile/vacation-slots">
                    <i class="fa-solid fa-calendar-check me-2" aria-hidden="true"></i>My Vacation Slots
                    <% if (currentUser && currentUser.vacationSlots && currentUser.vacationSlots.length> 0) { %>
                      <span class="badge bg-primary ms-2">
                        <%= currentUser.vacationSlots.length %>
                      </span>
                      <% } %>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/trip-planner/my-trips">
                    <i class="fa-solid fa-suitcase-rolling me-2" aria-hidden="true"></i>My Trip Plans
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/phrase-assistant">
                    <i class="fa-solid fa-language me-2" aria-hidden="true"></i>Phrase Assistant
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="downloadsDropdownToggle" data-bs-toggle="modal"
                    data-bs-target="#downloadsModal">
                    <i class="fa-solid fa-download me-2" aria-hidden="true"></i>My Downloads
                    <span id="profileDownloadCount" class="badge bg-primary ms-2" style="display: none;">0</span>
                  </a>
                </li>
                <% if (currentUser && currentUser.isAdmin) { %>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li>
                    <a class="dropdown-item" href="/admin/dashboard">
                      <i class="fa-solid fa-chart-line me-2" aria-hidden="true"></i>Admin Dashboard
                    </a>
                  </li>
                  <% } %>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li>
                      <a class="dropdown-item" href="/logout">
                        <i class="fa-solid fa-sign-out-alt me-2" aria-hidden="true"></i>
                        <%= __('logout') %>
                      </a>
                    </li>
              </ul>
            </div>

            <!-- Notification Bell -->
            <div class="dropdown">
              <button class="btn btn-outline-secondary position-relative" type="button" id="notificationToggle"
                data-bs-toggle="dropdown" aria-expanded="false" aria-label="View notifications">
                <i class="fa-solid fa-bell" aria-hidden="true"></i>
                <span id="notificationBadge" class="badge bg-danger position-absolute top-0 start-100 translate-middle"
                  style="display: none;">0</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end notification-dropdown"
                style="width: 350px; max-height: 400px; overflow-y: auto;" aria-labelledby="notificationToggle">
                <div class="dropdown-header d-flex justify-content-between align-items-center p-3 border-bottom">
                  <h6 class="mb-0">Notifications</h6>
                  <button id="markAllRead" class="btn btn-sm btn-outline-primary" type="button">Mark All Read</button>
                </div>
                <div id="notificationList" class="notification-list">
                  <div class="text-center text-muted p-4" id="noNotifications">
                    <i class="fa-solid fa-bell-slash fa-2x mb-2" aria-hidden="true"></i>
                    <p>No notifications yet</p>
                  </div>
                </div>
                <div class="dropdown-footer p-2 border-top">
                  <a href="/notifications" class="text-decoration-none text-center d-block">
                    <small>View All Notifications</small>
                  </a>
                </div>
              </div>
            </div>
            <% } %>

              <!-- Language Dropdown -->
              <div class="dropdown">
                <button class="btn dropdown-toggle" type="button" id="languageToggle" data-bs-toggle="dropdown"
                  aria-expanded="false" aria-label="Select language">
                  <i class="fa-solid fa-globe" aria-hidden="true"></i>
                  <span id="currentLanguageDisplay">
                    <%= languageMap[getLocale()].flag %>
                      <%= languageMap[getLocale()].name %>
                  </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageToggle">
                  <% Object.keys(languageMap).forEach(lang=> { %>
                    <li>
                      <a class="dropdown-item <%= getLocale() === lang ? 'active' : '' %>"
                        href="<%= buildLangUrl(lang) %>">
                        <%= languageMap[lang].flag %>
                          <%= languageMap[lang].name %>
                      </a>
                    </li>
                    <% }); %>
                </ul>
              </div>

              <!-- Theme Toggle -->
              <%- include("../includes/theme-toggle.ejs") %>
      </div>
    </div>
  </div>
</nav>

<!-- Scripts for Logged-in Users -->
<% if (typeof currentUser !=='undefined' && currentUser) { %>
  <script>
    (function () {
      'use strict';

      // Initialize on DOM ready
      document.addEventListener('DOMContentLoaded', function () {
        if (window.OfflineManager) {
          initializeDownloadsDropdown();
        }

        if (typeof currentUser !== 'undefined' && currentUser) {
          window.notificationManager = new NotificationManager();
        }
      });

      // Downloads Manager
      async function initializeDownloadsDropdown() {
        try {
          const trips = await window.OfflineManager.getStoredPdfs();
          updateDownloadsBadge(trips);
        } catch (error) {
          console.error('Error initializing downloads:', error);
        }
      }

      function updateDownloadsBadge(trips) {
        const badge = document.getElementById('profileDownloadCount');
        if (!badge) return;

        if (trips && trips.length > 0) {
          badge.textContent = trips.length;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }

      window.viewDownloadedTrip = async function (tripId) {
        try {
          if (!window.OfflineManager) return;

          const pdfData = await window.OfflineManager.getTripPdf(tripId);
          if (pdfData) {
            const blob = new Blob([pdfData], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
          } else {
            showToast('PDF not found', 'error');
          }
        } catch (error) {
          console.error('Error viewing downloaded trip:', error);
          showToast('Failed to open PDF', 'error');
        }
      };

      // Notification Manager
      class NotificationManager {
        constructor() {
          this.notifications = [];
          this.unreadCount = 0;
          this.isInitialized = false;
          this.init();
        }

        async init() {
          if (this.isInitialized) return;

          try {
            await this.loadNotifications();
            this.setupEventListeners();
            this.isInitialized = true;
          } catch (error) {
            console.error('Failed to initialize notifications:', error);
          }
        }

        async loadNotifications() {
          try {
            const response = await fetch('/trip-planner/api/notifications');
            if (response.ok) {
              this.notifications = await response.json();
              this.updateUnreadCount();
              this.renderNotifications();
            }
          } catch (error) {
            console.error('Failed to load notifications:', error);
          }
        }

        updateUnreadCount() {
          this.unreadCount = this.notifications.filter(n => !n.isRead).length;
          this.updateBadge();
        }

        updateBadge() {
          const badge = document.getElementById('notificationBadge');
          if (badge) {
            if (this.unreadCount > 0) {
              badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          }
        }

        renderNotifications() {
          const container = document.getElementById('notificationList');
          const noNotifications = document.getElementById('noNotifications');

          if (!container) return;

          if (this.notifications.length === 0) {
            if (noNotifications) noNotifications.style.display = 'block';
            return;
          }

          if (noNotifications) noNotifications.style.display = 'none';

          const recentNotifications = this.notifications.slice(0, 5);
          container.innerHTML = recentNotifications.map(n => this.createNotificationHTML(n)).join('');
        }

        createNotificationHTML(notification) {
          const timeAgo = this.getTimeAgo(notification.createdAt);
          const unreadClass = notification.isRead ? '' : 'unread';

          return `
        <div class="notification-item p-3 border-bottom ${unreadClass}" data-id="${notification._id}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">${this.escapeHtml(notification.title)}</h6>
              <p class="mb-1 text-muted small">${this.escapeHtml(notification.message)}</p>
              <small class="text-muted">${timeAgo}</small>
            </div>
            <div class="ms-2">
              ${!notification.isRead ? `
                <button class="btn btn-sm btn-link" onclick="window.notificationManager.markAsRead('${notification._id}')" title="Mark as read">
                  <i class="fa-solid fa-check"></i>
                </button>
              ` : ''}
              <button class="btn btn-sm btn-link text-danger" onclick="window.notificationManager.deleteNotification('${notification._id}')" title="Delete">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
        }

        escapeHtml(text) {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.replace(/[&<>"']/g, m => map[m]);
        }

        getTimeAgo(dateString) {
          const now = new Date();
          const date = new Date(dateString);
          const diffInSeconds = Math.floor((now - date) / 1000);

          if (diffInSeconds < 60) return 'Just now';
          if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
          if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
          return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        setupEventListeners() {
          const markAllReadBtn = document.getElementById('markAllRead');
          if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', () => this.markAllAsRead());
          }
        }

        async markAsRead(notificationId) {
          try {
            const response = await fetch(`/trip-planner/api/notifications/${notificationId}/read`, {
              method: 'PATCH'
            });

            if (response.ok) {
              const notification = this.notifications.find(n => n._id === notificationId);
              if (notification) {
                notification.isRead = true;
                this.updateUnreadCount();
                this.renderNotifications();
              }
            }
          } catch (error) {
            console.error('Failed to mark notification as read:', error);
            showToast('Failed to mark notification as read', 'error');
          }
        }

        async markAllAsRead() {
          try {
            const unreadNotifications = this.notifications.filter(n => !n.isRead);

            for (const notification of unreadNotifications) {
              await this.markAsRead(notification._id);
            }

            showToast('All notifications marked as read', 'success');
          } catch (error) {
            console.error('Failed to mark all notifications as read:', error);
            showToast('Failed to mark all notifications as read', 'error');
          }
        }

        async deleteNotification(notificationId) {
          try {
            const response = await fetch(`/trip-planner/api/notifications/${notificationId}`, {
              method: 'DELETE'
            });

            if (response.ok) {
              this.notifications = this.notifications.filter(n => n._id !== notificationId);
              this.updateUnreadCount();
              this.renderNotifications();
              showToast('Notification deleted', 'success');
            }
          } catch (error) {
            console.error('Failed to delete notification:', error);
            showToast('Failed to delete notification', 'error');
          }
        }

        addNotification(notification) {
          this.notifications.unshift(notification);
          this.updateUnreadCount();
          this.renderNotifications();
          showToast(notification.title, 'info');
        }
      }

      // Toast notification function
      window.showToast = function (message, type) {
        const alertClass = {
          'success': 'alert-success',
          'error': 'alert-danger',
          'info': 'alert-info',
          'warning': 'alert-warning'
        }[type] || 'alert-info';

        const iconClass = {
          'success': 'fa-check-circle',
          'error': 'fa-times-circle',
          'info': 'fa-info-circle',
          'warning': 'fa-exclamation-circle'
        }[type] || 'fa-info-circle';

        const toast = document.createElement('div');
        toast.className = `alert ${alertClass} position-fixed shadow`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `<i class="fa-solid ${iconClass} me-2"></i>${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      };
    })();
  </script>
  <% } %>